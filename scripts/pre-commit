#!/usr/bin/env bash
set -e

echo "→ Running format & lint on staged files via Docker Compose..."

# ステージされた Ruby ファイル一覧
staged_ruby=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rb$' || true)

if [ -n "$staged_ruby" ]; then
  echo "Formatting Ruby files in app container..."
  for file in $staged_ruby; do
    # app コンテナ内で RuboCop auto-correct を実行
    docker compose exec app bash -c "bundle exec rubocop -a \"$file\""
    # 変更があれば再ステージ
    git add "$file"
  done
fi

# ステージされた JS/TS/Vue ファイル一覧
staged_fe=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue)$' || true)

if [ -n "$staged_fe" ]; then
  echo "Formatting frontend files in web container..."
  for file in $staged_fe; do
    # web コンテナ内で ESLint auto-fix を実行
    docker compose exec web bash -c "npx eslint --fix \"$file\""
    # 変更があれば再ステージ
    git add "$file"
  done
fi

echo "→ format & lint completed."
